<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>NSW Pub Checklist</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
      body { 
        font-family: sans-serif; 
        margin: 0; 
        padding: 0; 
        overflow-x: hidden; 
      }
      #map {
        height: 600px;
        width: 100%;
        border: 2px solid #ccc;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
      #counters {
        margin: 10px 20px;
        padding: 15px 25px;
        background: #f9f9f9;
        border: 1px solid #ccc;
        border-radius: 20px;
        width: fit-content;
        text-align: left;   
      }
      .person {
        display: grid;
        grid-template-columns: auto 70px; 
        align-items: center;
        gap: 10px;
        margin: 5px 0;
        font-size: 16px;
        font-weight: bold;
      }
      #counters span {
        display: inline-block;
        min-width: 30px;
        text-align: center;
        background: #e0e0e0;
        padding: 2px 6px;
        border-radius: 5px;
      }
      #counters .total {
        font-size: 18px;
        font-weight: bold;
        background: #dff0d8;
        padding: 5px 35px;
        border-radius: 8px;
        margin-top: 5px;
      }
      #syncStatus {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        background: #4CAF50;
        color: white;
        border-radius: 5px;
        font-size: 12px;
        z-index: 1000;
      }
      #syncStatus.syncing {
        background: #FF9800;
      }
      #syncStatus.error {
        background: #f44336;
      }
    </style>
  </head>
  <body>
    <div id="syncStatus">üîÑ Connecting...</div>

    <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
      <div style="flex: 0 0 auto; margin-right: 5px;">
        <h1 style="margin: 0 0 5px 10px;">NSW Pub Checklist</h1>
        <p style="margin-left: 10px; margin-top: 0;">how many ya been to?</p>
        <div style="margin: 5px 5px; position: relative;">
          <input id="searchBox" type="text" placeholder="Search pubs..." 
                 style="padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 6px;">
          <div id="suggestions" 
               style="background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; position: absolute; width: 300px; display:none; z-index:1000;">
          </div>
        </div>
      </div>

      <div style="display: flex; align-items: center; gap: 8px; flex: 1; justify-content: flex-end; margin-top: 20px;">
        <div id="imageRow" style="display: flex; gap: 8px; align-items: center;">
          <img src="Data/peace sign.jpg" style="height: 110px; border-radius: 5px;">
          <img src="Data/KegTooheysOld.webp" style="height: 110px; border-radius: 5px;">
          <img src="Data/backtoback.jpg" style="height: 110px; border-radius: 5px;">
          <img src="Data/tooheys old beer.jpeg" style="height: 110px; border-radius: 5px;">
          <img src="Data/69.jpg" style="height: 110px; border-radius: 5px;">
        </div>

        <div id="counters" style="margin-left: 5px;">
          <div class="person">Jana <span id="countA">0</span></div>
          <div class="person">Brendan <span id="countB">0</span></div>
          <div class="person total">Total <span id="countTotal">0</span></div>
        </div>
      </div>
    </div>

    <div style="display: flex; margin-top: 10px; flex-wrap: wrap;">
      <div id="lgaTableContainer" style="flex: 0 0 280px; padding: 10px; max-width: 100%;">
        <table id="lgaTable" border="1" cellpadding="5" style="border-collapse: collapse; width: 100%;">
          <thead>
            <tr>
              <th>LGA</th>
              <th>Jana</th>
              <th>Brendan</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="flex: 1; padding: 10px; min-width: 300px;">
        <div id="map"></div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyApRi7wG8zT9j7AAI8ot2NGHHEn4khMbHY",
        authDomain: "publicity-b5755.firebaseapp.com",
        databaseURL: "https://publicity-b5755-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "publicity-b5755",
        storageBucket: "publicity-b5755.firebasestorage.app",
        messagingSenderId: "863893672681",
        appId: "1:863893672681:web:cdd006cfa72862b97f1678"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const visitedRef = db.ref('visited/shared');
      
      let visited = {};
      let isInitialLoad = true;
      let localUpdateInProgress = false;

      // Sync status indicator
      function setSyncStatus(status, message) {
        const indicator = document.getElementById('syncStatus');
        indicator.className = status;
        indicator.textContent = message;
      }

      // Initialize the app
      let countA = 0, countB = 0, countTotal = 0;
      let lgaStats = {};
      let totalPubs = 0;
      let map, bounds, pubList = [];
      window.markers = {};

      function recalculateCounts() {
        countA = 0;
        countB = 0;
        countTotal = 0;
        
        Object.values(visited).forEach(record => {
          if (record.Jana) countA++;
          if (record.Brendan) countB++;
          if (record.Jana || record.Brendan) countTotal++;
        });

        // Recalculate LGA stats
        for (let lga in lgaStats) {
          lgaStats[lga].Jana = 0;
          lgaStats[lga].Brendan = 0;
        }

        for (let key in window.markers) {
          let markerInfo = window.markers[key];
          let v = visited[key];
          if (!v) continue;
          let lga = markerInfo.lga;
          if (v.Jana) lgaStats[lga].Jana++;
          if (v.Brendan) lgaStats[lga].Brendan++;
        }

        updateUI();
      }

      function updateUI() {
        document.getElementById("countA").innerText = `${countA}/${totalPubs}`;
        document.getElementById("countB").innerText = `${countB}/${totalPubs}`;
        document.getElementById("countTotal").innerText = `${countTotal}/${totalPubs}`;
        updateLgaTable();
        
        // Update all markers
        for (let key in window.markers) {
          updateMarker(window.markers[key].marker, key, window.markers[key].displayName);
        }
      }

      function updateMarker(marker, pubName, displayName) {
        let jana = visited[pubName]?.Jana;
        let brendan = visited[pubName]?.Brendan;
        let color = "black";
        if (jana && brendan) color = "#00b300";
        else if (jana) color = "#4da6ff";
        else if (brendan) color = "#ff6666";
        marker.setStyle({ color, fillColor: color });
        
        let janaStatus = jana ? "‚úÖ Jana" : "‚ùå Jana";
        let brendanStatus = brendan ? "‚úÖ Brendan" : "‚ùå Brendan";
        marker.bindTooltip(`${displayName}<br>${janaStatus} | ${brendanStatus}`, { 
          permanent: false, 
          direction: "top" 
        });
      }

      function toggleVisited(person, pubName, marker, checkbox) {
        localUpdateInProgress = true;
        setSyncStatus('syncing', 'üîÑ Syncing...');
        
        if (!visited[pubName]) {
          visited[pubName] = { Jana: false, Brendan: false };
        }
        
        visited[pubName][person] = checkbox.checked;
        
        // Update Firebase
        visitedRef.child(pubName).set(visited[pubName])
          .then(() => {
            setSyncStatus('', '‚úÖ Synced');
            setTimeout(() => setSyncStatus('', ''), 2000);
            localUpdateInProgress = false;
          })
          .catch(err => {
            console.error('Firebase update error:', err);
            setSyncStatus('error', '‚ùå Sync failed');
            localUpdateInProgress = false;
          });
        
        recalculateCounts();
      }

      function updateLgaTable() {
        let tbody = document.querySelector("#lgaTable tbody");
        tbody.innerHTML = "";
        let sorted = Object.entries(lgaStats).sort((a, b) => {
          let totalA = a[1].Jana + a[1].Brendan;
          let totalB = b[1].Jana + b[1].Brendan;
          return totalB - totalA;
        });
        for (let [lga, stats] of sorted) {
          let row = document.createElement("tr");
          row.innerHTML = `<td>${lga}</td><td>${stats.Jana}/${stats.total}</td><td>${stats.Brendan}/${stats.total}</td>`;
          tbody.appendChild(row);
        }
      }

      // Setup search functionality
      const searchBox = document.getElementById("searchBox");
      const suggestions = document.getElementById("suggestions");

      function setupSearch() {
        searchBox.addEventListener("input", function () {
          const query = this.value.toLowerCase();
          suggestions.innerHTML = "";
          if (!query) { 
            suggestions.style.display = "none"; 
            return; 
          }
          const matches = pubList.filter(p => p.displayName.toLowerCase().includes(query)).slice(0, 10);
          if (matches.length === 0) { 
            suggestions.style.display = "none"; 
            return; 
          }
          matches.forEach(match => {
            const div = document.createElement("div");
            div.textContent = match.displayName;
            div.style.padding = "5px";
            div.style.cursor = "pointer";
            div.addEventListener("click", () => { 
              zoomToPub(match.key); 
              suggestions.style.display = "none"; 
              searchBox.value = match.displayName; 
            });
            div.addEventListener("mouseover", () => div.style.background = "#f0f0f0");
            div.addEventListener("mouseout", () => div.style.background = "white");
            suggestions.appendChild(div);
          });
          suggestions.style.display = "block";
        });
      }

      function zoomToPub(key) {
        const markerInfo = window.markers[key];
        if (!markerInfo) return;
        map.setView(markerInfo.marker.getLatLng(), 14);
        markerInfo.marker.openPopup();
      }

      // Initialize Firebase listener first
      visitedRef.on('value', (snapshot) => {
        if (localUpdateInProgress) return; // Skip updates triggered by local changes
        
        const firebaseData = snapshot.val() || {};
        
        if (isInitialLoad) {
          // On first load, merge localStorage with Firebase
          const localStorage = JSON.parse(window.localStorage.getItem("visitedPubs")) || {};
          
          // Merge: Firebase takes precedence, but include any local-only data
          visited = { ...localStorage, ...firebaseData };
          
          // If we had local data that wasn't in Firebase, push it
          if (Object.keys(localStorage).length > 0) {
            visitedRef.set(visited);
          }
          
          isInitialLoad = false;
          setSyncStatus('', '‚úÖ Connected');
        } else {
          // Subsequent updates from other devices
          visited = firebaseData;
          recalculateCounts();
          setSyncStatus('', 'üîÑ Updated from server');
          setTimeout(() => setSyncStatus('', ''), 2000);
        }
        
        // Always backup to localStorage
        window.localStorage.setItem("visitedPubs", JSON.stringify(visited));
      });

      // Load pubs and create map
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      bounds = L.latLngBounds();

      fetch("Data/nsw_pubs.json")
        .then(r => r.json())
        .then(pubs => {
          pubs.forEach(pub => {
            let pubName = pub["Licence.name"];
            let suburb = pub["Suburb"];
            let lga = pub["LGA"].trim();
            totalPubs++;
            
            if (!lgaStats[lga]) {
              lgaStats[lga] = { total: 0, Jana: 0, Brendan: 0 };
            }
            lgaStats[lga].total++;

            let key = `${pubName}, ${suburb}`;
            let displayName = key;
            pubList.push({ key, displayName });

            if (visited[key]?.Jana) lgaStats[lga].Jana++;
            if (visited[key]?.Brendan) lgaStats[lga].Brendan++;

            function getPopupContent() {
              return `
                <b>${displayName}</b><br>
                <label>Jana <input type="checkbox" id="jana-${btoa(key)}" ${visited[key]?.Jana ? "checked" : ""}></label><br>
                <label>Brendan <input type="checkbox" id="brendan-${btoa(key)}" ${visited[key]?.Brendan ? "checked" : ""}></label>
              `;
            }

            let marker = L.circleMarker([pub.Latitude, pub.Longitude], {
              radius: 5, 
              color: "black", 
              fillColor: "black", 
              fillOpacity: 0.8
            }).addTo(map);

            bounds.extend([pub.Latitude, pub.Longitude]);
            marker.bindTooltip(displayName, { permanent: false, direction: "top" });
            marker.bindPopup(getPopupContent());

            marker.on("popupopen", function(e) {
              e.popup.setContent(getPopupContent());
              const janaBox = document.getElementById(`jana-${btoa(key)}`);
              const brendanBox = document.getElementById(`brendan-${btoa(key)}`);
              if (janaBox) {
                janaBox.addEventListener("change", () => {
                  toggleVisited("Jana", key, window.markers[key].marker, janaBox);
                });
              }
              if (brendanBox) {
                brendanBox.addEventListener("change", () => {
                  toggleVisited("Brendan", key, window.markers[key].marker, brendanBox);
                });
              }
            });

            window.markers[key] = { marker, displayName, lga };
            updateMarker(marker, key, displayName);
          });

          map.fitBounds(bounds, { padding: [50, 50], maxZoom: 10 });
          map.invalidateSize();
          
          recalculateCounts();
          setupSearch();
        })
        .catch(err => {
          console.error('Error loading pubs:', err);
          setSyncStatus('error', '‚ùå Failed to load pubs');
        });

      // Handle connection status
      db.ref('.info/connected').on('value', (snapshot) => {
        if (snapshot.val() === true) {
          setSyncStatus('', '‚úÖ Connected');
        } else {
          setSyncStatus('error', '‚ùå Offline');
        }
      });
    </script>
  </body>
</html>
